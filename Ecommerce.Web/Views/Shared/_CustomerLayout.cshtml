<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Foodify - @ViewData["Title"]</title>
    <meta content="width=device-width, initials-scale=1.0" name="viewport">
    <meta content="foodify, foods, foodshop, groceries, vegetables, fruits, meat, bread" name="keywords">
    <meta content="Food Store" name="description">
    <link rel="icon" type="image/png" href="/images/favicon.png">
    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Raleway:wght@600;800&display=swap" rel="stylesheet">
    <!-- Icon Font Stylesheet -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Libraries Stylesheet -->
    <link href="~/customer/lib/lightbox/css/lightbox.min.css" rel="stylesheet">
    <link href="~/customer/lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">
    <!-- Customized Bootstrap Stylesheet -->
    <link href="~/customer/css/bootstrap.min.css" rel="stylesheet">
    <!-- Template Stylesheet -->
    <link href="~/customer/css/style.css" rel="stylesheet">
    @* toastify *@
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
</head>
<body>

    <!-- Spinner Start -->
    <div id="spinner" class="show w-100 vh-100 bg-white position-fixed translate-middle top-50 start-50  d-flex align-items-center justify-content-center">
        <div class="spinner-grow text-primary" role="status"></div>
    </div>
    <!-- Spinner End -->

    <!-- Navbar start -->
    <div class="container-fluid fixed-top" style="top: 0px">
        <div class="container px-0">
            <nav class="navbar navbar-light bg-white navbar-expand-xl">
                <a asp-controller="home" asp-action="index" class="navbar-brand"><h1 class="text-primary display-6">Foodify</h1></a>
                <button class="navbar-toggler py-2 px-3" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse">
                    <span class="fa fa-bars text-primary"></span>
                </button>
                <div class="collapse navbar-collapse bg-white" id="navbarCollapse">
                    <div class="navbar-nav mx-auto">
                        <a asp-area="customer" asp-controller="home" asp-action="index" class="nav-item nav-link">Home</a>
                        <a asp-area="customer" asp-controller="Shop" asp-action="Index" class="nav-item nav-link">Shop</a>
                        <a asp-area="Customer" asp-controller="Home" asp-action="Contact" class="nav-item nav-link">Contact</a>
                    </div>
                    <div class="d-flex m-3 me-0">
                        <a asp-area="customer" asp-controller="shoppingCarts" asp-action="index" class="position-relative me-4 my-auto">
                            <i class="fa fa-shopping-bag fa-2x"></i>
                            <span id="cartCount" class="position-absolute bg-secondary rounded-circle d-flex align-items-center justify-content-center text-dark px-1" style="top: -5px; left: 15px; height: 20px; min-width: 20px;">0</span>
                        </a>
                        <a href="#" class="my-auto">
                            <partial name="_LoginPartial"></partial>
                        </a>
                    </div>
                </div>
            </nav>
        </div>
    </div>
    <!-- Navbar End -->

    @RenderBody()
    <!-- Footer Start -->
    <div class="container-fluid bg-dark text-white-50 footer pt-5 mt-5">
        <div class="container py-1">
            <div class="pb-4 mb-4" style="border-bottom: 1px solid rgba(226, 175, 24, 0.5) ;">
                <div class="row g-4">
                    <div class="col-6">
                        <a href="/customer/home/index">
                            <h1 class="text-primary mb-0">Foodify</h1>
                            <p class="text-secondary mb-0">High quality foods</p>
                        </a>
                    </div>
                    <div class="col-6">
                        <div class="d-flex justify-content-end pt-3">
                            <a class="btn  btn-outline-secondary me-2 btn-md-square rounded-circle" target="_blank" href="https://github.com/abohend"><i class="fab fa-github"></i></a>
                            <a class="btn btn-outline-secondary me-2 btn-md-square rounded-circle" target="_blank" href="https://linkedin.com/in/abohend"><i class="fab fa-linkedin-in"></i></a>
                            <a class="btn btn-outline-secondary me-2 btn-md-square rounded-circle" target="_blank" href="https://fb.com/mabohend"><i class="fab fa-facebook"></i></a>
                            <a class="btn btn-outline-secondary btn-md-square rounded-circle" target="_blank" href=""><i class="fab fa-youtube"></i></a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row g-5">
                <div class="col-12 col-xl-6">
                    <div class="footer-item">
                        <h4 class="text-light mb-3">Why People Like us!</h4>
                        <p class="mb-4">
                            People like us because our high quality products.
                            They are always fresh and contributed with love.
                            Your health is our periority.
                            People like us because our high quality products.
                            They are always fresh and contributed with love.
                        </p>
                        @* <a href="" class="btn border-secondary py-2 px-4 rounded-pill text-primary">Read More</a> *@
                    </div>
                </div>
                <div class="col-4 col-xl-2">
                    <div class="d-flex flex-column text-start footer-item">
                        <h4 class="text-light mb-3">Account</h4>
                        <a class="btn-link" href="/Identity/Account/Manage">My Account</a>
                        <a class="btn-link" href="/Customer/Shop/Index">Shop</a>
                        <a class="btn-link" href="/Customer/Shoppingcart">Shopping Cart</a>
                        @* <a class="btn-link" href="">Order History</a> *@
                    </div>
                </div>
                <div class="col-6 col-xl-4">
                    <div class="footer-item">
                        <h4 class="text-light mb-3">Contact</h4>
                        <p>Address: 1429 Netus Rd, NY 48247</p>
                        <p>Email: Example@gmail.com</p>
                        <p>Phone: +0123 4567 8910</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Footer End -->

    <!-- Copyright Start -->
    <div class="container-fluid copyright bg-dark py-4">
        <div class="container">
            <div class="row">
                <div class="col-md-6 text-center text-md-start mb-3 mb-md-0">
                    <span class="text-light"><a href="/customer/home/index"><i class="fas fa-copyright text-light me-2"></i>Foodify</a>, All right reserved.</span>
                </div>
                <div class="col-md-6 my-auto text-center text-md-end text-white">
                    Made By <a class="border-bottom" href="https://linkedin.com/in/abohend" target="_blank">Abohend</a>
                </div>
            </div>
        </div>
    </div>
    <!-- Copyright End -->
    
    <!-- Back to Top -->
    <a href="#" class="btn btn-primary border-3 border-primary rounded-circle back-to-top"><i class="fa fa-arrow-up"></i></a>


    <!-- JavaScript Libraries -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/customer/lib/easing/easing.min.js"></script>
    <script src="~/customer/lib/waypoints/waypoints.min.js"></script>
    <script src="~/customer/lib/lightbox/js/lightbox.min.js"></script>
    <script src="~/customer/lib/owlcarousel/owl.carousel.min.js"></script>
    <script src="~/lib/jquery-ajax-unobtrusive/jquery.unobtrusive-ajax.min.js"></script>
    <!-- Template Javascript -->
    <script src="~/customer/js/main.js"></script>
    @* toastify *@
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    @*custom scripts*@
    <script>
        // toggle active class on navbar buttons
        (function ($) {
            function normalizePath(path) {
                // remove trailing slash except root
                if (!path) return "/";
                return path.length > 1 && path.endsWith("/") ? path.slice(0, -1) : path;
            }

            function setActiveByUrl() {
                var currentPath = normalizePath(window.location.pathname.toLowerCase());
                var found = false;

                // Check direct nav links first
                $('.navbar-nav .nav-link').each(function () {
                    var $link = $(this);
                    var href = ($link.attr('href') || '').toLowerCase();
                    if (!href) return;

                    // Normalize href (strip origin if present)
                    try {
                        var url = new URL(href, window.location.origin);
                        href = normalizePath(url.pathname);
                    } catch (e) {
                        href = normalizePath(href);
                    }

                    if (href === "/" && currentPath === "/") {
                        $('.navbar-nav .nav-link').removeClass('active');
                        $link.addClass('active');
                        found = true;
                        return false; // break
                    }

                    // mark active when link path is prefix of current path (e.g., /products -> /products/12)
                    if (href !== "/" && currentPath.indexOf(href) === 0) {
                        $('.navbar-nav .nav-link').removeClass('active');
                        $link.addClass('active');
                        found = true;
                        return false; // break
                    }
                });

                // If not found, try matching dropdown items and mark parent trigger active
                if (!found) {
                    $('.dropdown-menu .dropdown-item').each(function () {
                        var $item = $(this);
                        var href = ($item.attr('href') || '').toLowerCase();
                        if (!href) return;

                        try {
                            var url = new URL(href, window.location.origin);
                            href = normalizePath(url.pathname);
                        } catch (e) {
                            href = normalizePath(href);
                        }

                        if (href !== "/" && currentPath.indexOf(href) === 0) {
                            $('.navbar-nav .nav-link').removeClass('active');
                            $item.closest('.nav-item.dropdown').find('> a.nav-link').addClass('active');
                            found = true;
                            return false;
                        }
                    });
                }
            }

            function attachClickHandlers() {
                // top-level nav links
                $('.navbar-nav').on('click', '.nav-link', function () {
                    $('.navbar-nav .nav-link').removeClass('active');
                    $(this).addClass('active');
                });

                // dropdown items should mark their parent trigger active
                $('.navbar-nav').on('click', '.dropdown-menu .dropdown-item', function () {
                    $('.navbar-nav .nav-link').removeClass('active');
                    $(this).closest('.nav-item.dropdown').find('> a.nav-link').addClass('active');
                });
            }

            $(document).ready(function () {
                setActiveByUrl();
                attachClickHandlers();
            });

            // Expose for testing or manual invocation if needed
            window._navbarActive = {
                setActiveByUrl: setActiveByUrl
            };
        })(jQuery);


        // Global Cart Logic
        (function () {
            window.userCart = {}; // productId -> amount

            // Helper: Get HTML for the control
            window.getCartControlHtml = function(productId, amount) {
                if (amount > 0) {
                    return `
                        <div class="d-flex justify-content-center align-items-center w-100">
                            <button onclick="handleCartAction(${productId}, 'dec')" class="btn btn-sm btn-light rounded-circle border">
                                <i class="fa fa-minus text-primary"></i>
                            </button>
                            <span class="mx-3 fw-bold text-primary" id="qty-${productId}">${amount}</span>
                            <button onclick="handleCartAction(${productId}, 'inc')" class="btn btn-sm btn-light rounded-circle border">
                                <i class="fa fa-plus text-primary"></i>
                            </button>
                        </div>
                    `;
                } else {
                    return `
                        <button onclick="handleCartAction(${productId}, 'inc')" class="btn border border-secondary rounded-pill px-3 text-primary">
                            <i class="fa fa-shopping-bag me-2 text-primary"></i>
                            Add to cart
                        </button>
                    `;
                }
            };

            // Helper: Update badge
            function updateCartBadge() {
                let total = 0;
                for (let key in window.userCart) {
                    total += window.userCart[key];
                }
                $("#cartCount").text(total);
            }

            // Helper: Update a specific container
            window.updateProductCard = function(productId, amount) {
                const container = document.getElementById(`action-container-${productId}`);
                if(container) {
                    container.innerHTML = window.getCartControlHtml(productId, amount);
                }
            };

            // Helper: Update all containers on page (useful after initial fetch)
            window.updateAllProductCards = function() {
                const containers = document.querySelectorAll('[id^="action-container-"]');
                containers.forEach(container => {
                    const idPart = container.id.replace('action-container-', '');
                    const productId = parseInt(idPart);
                    // If the product is not in userCart (undefined), amount is 0
                    const amount = window.userCart[productId] || 0;
                    container.innerHTML = window.getCartControlHtml(productId, amount);
                });
            };

            // Fetch Cart
            window.fetchUserCart = async function() {
                try {
                    const resp = await fetch('/Customer/ShoppingCarts/GetUserCart');
                    if (resp.ok) {
                        window.userCart = await resp.json();
                        updateCartBadge();
                        window.updateAllProductCards();
                    }
                } catch (err) {
                    console.error("Failed to fetch cart", err);
                }
            };

            // Handle Actions
            window.handleCartAction = async function(productId, action) {
                const endpoint = action === 'inc' ? 'Increment' : 'Decrement';
                const url = `/Customer/ShoppingCarts/${endpoint}?productId=${productId}`;
                
                try {
                    const resp = await fetch(url, { method: 'POST' });
                    
                    if (resp.redirected && resp.url.toLowerCase().includes("login")) {
                        Toastify({
                            text: "Please sign in to add items to cart",
                            duration: 3000,
                            gravity: "top", 
                            position: "right", 
                            style: { background: "linear-gradient(to right, #ff5f6d, #ffc371)" }
                        }).showToast();
                        return;
                    }

                    if(resp.ok) {
                        const data = await resp.json();
                        if(data.success) {
                            // Update local state
                            window.userCart[productId] = data.newAmount;
                            
                            // Update UI
                            window.updateProductCard(productId, data.newAmount);
                            updateCartBadge();
                            
                            // Optional: Show toast
                             Toastify({
                                text: data.message,
                                duration: 2000,
                                gravity: "top", 
                                position: "right", 
                                style: { background: "linear-gradient(to right, #ffb524, #81c408)" }
                            }).showToast();

                        } else {
                            console.error("Cart update failed", data);
                        }
                    }
                } catch(e) {
                    console.error("Error updating cart", e);
                }
            };

            // Initial Load
            $(document).ready(function () {
                window.fetchUserCart();
            });
        })();
    </script>
    
    @await RenderSectionAsync("Scripts", required: false)

</body>

</html>