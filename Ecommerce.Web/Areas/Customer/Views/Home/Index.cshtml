@model IEnumerable<Category>

@{
    ViewData["Title"] = "Home";
}

<!-- Hero Start -->
<div class="container-fluid py-5 mb-5 hero-header">
    <div class="container py-5">
        <div class="row g-5 align-items-center">
            <div class="col-md-12 col-lg-7">
                <h4 class="mb-3 text-secondary">100% Organic Foods</h4>
                <h2 class="mb-5 display-3 text-primary">Organic Veggies & Fruits Foods</h2>
                <div class="position-relative mx-auto">
                    <form asp-area="Customer" asp-controller="Shop" asp-action="Index" method="get" class="w-100">
                        <input name="Search" type="search" class="form-control border-2 border-secondary w-75 py-3 px-4 rounded-pill" placeholder="Search" required aria-label="Search" />
                        <button type="submit" class="btn btn-primary border-2 border-secondary py-3 px-4 position-absolute rounded-pill text-white h-100" style="top: 0; right: 25%;">Submit Now</button>
                    </form>
                </div>
            </div>
            <div class="col-md-12 col-lg-5">
                <div id="carouselId" class="carousel slide position-relative" data-bs-ride="carousel">
                    <div class="carousel-inner" role="listbox">
                        @{ var first = true; }
                        @foreach (var category in Model)
                        {
                            <div class="@(first ? "carousel-item rounded active" : "carousel-item rounded")">
                                <img src="@Url.Content("~/" + category.Image)" class="img-fluid w-100 h-100 bg-secondary rounded" alt="@category.Name">
                                <button type="button" class="btn px-4 py-2 text-white rounded category-filter-btn" data-category-id="@category.Id" onclick="location.href='#products-label'">@category.Name</button>
                            </div>
                            first = false;
                        }
                    </div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#carouselId" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#carouselId" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Hero End -->

<!-- Features Section Start -->
<div class="container-fluid featurs pt-5">
    <div class="container py-5">
        <div class="row g-4">
            <div class="col-md-6 col-lg-3">
                <div class="featurs-item text-center rounded bg-light p-4">
                    <div class="featurs-icon btn-square rounded-circle bg-secondary mb-5 mx-auto">
                        <i class="fas fa-car-side fa-3x text-white"></i>
                    </div>
                    <div class="featurs-content text-center">
                        <h5>Free Shipping</h5>
                        <p class="mb-0">Free on order over $300</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="featurs-item text-center rounded bg-light p-4">
                    <div class="featurs-icon btn-square rounded-circle bg-secondary mb-5 mx-auto">
                        <i class="fas fa-user-shield fa-3x text-white"></i>
                    </div>
                    <div class="featurs-content text-center">
                        <h5>Security Payment</h5>
                        <p class="mb-0">100% security payment</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="featurs-item text-center rounded bg-light p-4">
                    <div class="featurs-icon btn-square rounded-circle bg-secondary mb-5 mx-auto">
                        <i class="fas fa-exchange-alt fa-3x text-white"></i>
                    </div>
                    <div class="featurs-content text-center">
                        <h5>30 Day Return</h5>
                        <p class="mb-0">30 day money guarantee</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="featurs-item text-center rounded bg-light p-4">
                    <div class="featurs-icon btn-square rounded-circle bg-secondary mb-5 mx-auto">
                        <i class="fa fa-phone-alt fa-3x text-white"></i>
                    </div>
                    <div class="featurs-content text-center">
                        <h5>24/7 Support</h5>
                        <p class="mb-0">Support every time fast</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Features Section End -->

<!-- Fruits Shop Start-->
<div class="container-fluid fruite pt-5">
    <div class="container py-5">
        <div class="tab-class text-center">
            <div class="row g-4">
                <div class="col-lg-4 text-start">
                    <h2 id="products-label">Our Organic Products</h2>
                </div>
                <div class="col-lg-8 text-end">
                    <div class="d-inline-flex flex-wrap mb-5">
                        <button type="button" class="d-flex m-2 py-2 bg-light rounded-pill category-filter-btn active" data-category-id=""> 
                            <span class="text-dark" style="width: 130px;">All Products</span>
                        </button>
                        @foreach(var category in Model)
                        {
                            <button type="button" class="d-flex m-2 py-2 bg-light rounded-pill category-filter-btn" data-category-id="@category.Id">
                                <span class="text-dark" style="width: 130px;">@category.Name</span>
                            </button>
                        }
                    </div>
                </div>
            </div>

            <div class="tab-content">
                <!-- Dynamic products grid will be populated via JS -->
                <div id="productsGrid" class="row g-4">
                    <div class="col-12 text-center" id="productsStatus">Loading products...</div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Fruits Shop End-->

@section Scripts {
    <script>
        (function () {
            const productsGrid = document.getElementById('productsGrid');
            const productsStatus = document.getElementById('productsStatus');
            const categoryButtons = Array.from(document.querySelectorAll('.category-filter-btn'));

            function setActiveButton(button) {
                categoryButtons.forEach(b => b.classList.remove('active'));
                if (button) button.classList.add('active');
            }

            function renderProducts(products) {
                productsGrid.innerHTML = '';
                if (!products || products.length === 0) {
                    productsGrid.innerHTML = '<div class="col-12 text-center">No products found.</div>';
                    return;
                }

                products.forEach(product => {
                    const imgSrc = product.image && (product.image.startsWith('http') || product.image.startsWith('/'))
                        ? product.image
                        : '/' + (product.image || 'img/fruite-item-1.jpg');

                    const col = document.createElement('div');
                    col.className = 'col-md-6 col-lg-4 col-xl-3';

                    // Use global cart state to render the correct button state immediately
                    const amount = window.userCart ? (window.userCart[product.id] || 0) : 0;
                    const infoHtml = window.getCartControlHtml ? window.getCartControlHtml(product.id, amount) : '';

                    col.innerHTML = `
                        <div class="rounded position-relative fruite-item">
                            <div class="fruite-img">
                                <img src="${imgSrc}" class="img-fluid w-100 rounded-top" alt="${escapeHtml(product.name)}">
                            </div>
                            <div class="text-white bg-secondary px-3 py-1 rounded position-absolute" style="top: 10px; left: 10px;">${escapeHtml(product.categoryName || 'X')}</div>
                            <div class="p-4 border border-secondary border-top-0 rounded-bottom">
                                <h4>${escapeHtml(product.name)}</h4>
                                <p>${escapeHtml(product.description || '')}</p>
                                <div class="d-flex justify-content-between flex-lg-wrap align-items-center">
                                    <p class="text-dark fs-5 fw-bold mb-0 me-2">$${parseFloat(product.price || 0).toFixed(2)} / kg</p>
                                    <div id="action-container-${product.id}" class="d-flex align-items-center">
                                        ${infoHtml}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    productsGrid.appendChild(col);
                });
            }

            function escapeHtml(text) {
                if (text === null || text === undefined) return '';
                const str = typeof text === 'string' ? text : String(text);
                return str
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
            }

            async function loadProducts(categoryId) {
                productsGrid.innerHTML = '<div class="col-12 text-center">Loading products...</div>';
                try {
                    // Ensure cart is fetched *before* rendering if not already
                    if (!window.userCart || Object.keys(window.userCart).length === 0) {
                         if (window.fetchUserCart) await window.fetchUserCart();
                    }
                    
                    const url = categoryId ? `/customer/shop/index?categoryId=${encodeURIComponent(categoryId)}` : '/customer/shop/index';
                    const resp = await fetch(url, { method: 'GET', headers: { 'Accept': 'application/json' } });
                    if (!resp.ok) throw new Error('Network response was not ok');
                    const products = await resp.json();
                    renderProducts(products);
                } catch (err) {
                    console.error(err);
                    productsGrid.innerHTML = '<div class="col-12 text-center text-danger">Failed to load products.</div>';
                }
            }

            // Attach click handlers
            categoryButtons.forEach(btn => {
                btn.addEventListener('click', function () {
                    const categoryId = this.getAttribute('data-category-id') || '';
                    setActiveButton(this);
                    loadProducts(categoryId);
                });
            });

            // Initial load
            loadProducts();
        })();
    </script>
}